{% extends "base.html" %}

{% block content %}
<div class="dashboard-container fade-in">

  <!-- AI-Generated Mission Report -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI-Generated Mission Report</h5>
    </div>
    <div class="card-body">
      <p class="text-muted mb-2"><strong>Date:</strong> {{ datetime.utcnow().strftime('%Y-%m-%d') }}</p>
      
      <p><strong>Overview:</strong></p>
      <p>
        Field agents operating in the Southern Cape region have reported a significant increase in child displacement following severe
        flooding earlier this week. Emergency shelters are nearing full capacity, and families are requesting additional support for
        essential supplies. Infrastructure damage has delayed multiple supply routes, particularly those transporting medical kits, hygiene products,
        and non-perishable food items.
      </p>
      
      <p><strong>Health Situation:</strong></p>
      <p>
        A localized flu outbreak has been confirmed in Cluster 3, affecting at least 24 children under the age of 12. While no severe
        cases have been reported, the risk of further spread remains high due to crowded shelter conditions and limited access to healthcare.
        Mobile health units are being deployed to conduct screenings and distribute antiviral medications.
      </p>
      
      <p><strong>Operational Progress:</strong></p>
      <p>
        Despite the challenges, agents successfully reached 5 out of 7 targeted villages this week. Temporary access routes established
        with the support of local volunteers enabled the safe delivery of basic aid packages to isolated communities. Crisis Response
        Unit Alpha has been stationed near the flood zone to assist with evacuation coordination and logistical support.
      </p>
  
      <p><strong>Donations & Logistics:</strong></p>
      <p>
        Incoming donations increased by 8% this week, driven by a recent online awareness campaign. However, delivery capacity remains
        below optimal levels due to blocked roads and fuel shortages. Field leadership is prioritizing deliveries to areas with the highest
        urgency scores.
      </p>
  
      <hr class="my-4">
  
      <p><strong>Relevant News:</strong></p>
      <ul>
        <li>
          <strong>"Floods Displace Hundreds Across Southern Cape"</strong> – *ReliefTimes Africa*, May 9, 2025  
          <br><a href="#">https://relieftimes.org/southerncape-flooding-response</a>
        </li>
        <li>
          <strong>"Local Health Authority Confirms Flu Outbreak in Cluster 3"</strong> – *SA Medical News*, May 10, 2025  
          <br><a href="#">https://samedicalnews.co.za/flu-cluster3-outbreak</a>
        </li>
        <li>
          <strong>"Volunteers Build Emergency Roads for Aid Delivery in Flooded Villages"</strong> – *CapeVoice*, May 11, 2025  
          <br><a href="#">https://capevoice.org/emergency-aid-roads-southern-cape</a>
        </li>
      </ul>
  
      <p class="text-muted"><em>This report was automatically generated based on field data and scraped external news sources. Please verify facts before operational use.</em></p>
    </div>
  </div>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-tasks me-2"></i>Manager Dashboard - My Projects</h2>
    <div class="text-muted"><i class="fas fa-user-circle me-2"></i>{{ current_user.username }}</div>
  </div>

  <!-- Charts Row -->
  <div class="row mb-4">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">Overall Project Status</div>
        <div class="card-body">
          <div id="projectStatusPieChart" style="width:100%; height:350px;"></div>
          {% if not status_labels %}
          <p class="text-muted text-center mt-3">No project status data to display.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">Portfolio Financial Overview</div>
        <div class="card-body">
          <div id="portfolioFinancialsBarChart" style="width:100%; height:350px;"></div>
          {% if not portfolio_financial_labels %}
          <p class="text-muted text-center mt-3">No financial data to display.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Project Filter Buttons -->
  <div class="mb-4 mt-4">
    <div class="btn-group" role="group" aria-label="Project Status Filter">
      <button type="button" class="btn btn-outline-secondary active filter-btn" data-status="all">All</button>
      <button type="button" class="btn btn-outline-secondary filter-btn" data-status="Planning">Planning</button>
      <button type="button" class="btn btn-outline-secondary filter-btn" data-status="Ongoing">Ongoing</button>
      <button type="button" class="btn btn-outline-secondary filter-btn" data-status="Completed">Completed</button>
      <button type="button" class="btn btn-outline-secondary filter-btn" data-status="On Hold">On Hold</button>
    </div>
  </div>

  <!-- Donor Insights Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card action-card">
        <div class="card-body text-center">
          <h5 class="card-title"><i class="fas fa-donate me-2"></i>View Donor Insights</h5>
          <p class="card-text text-muted">Analyze donor contributions and overall fundraising efforts.</p>
          <a href="{{ url_for('donor_insights') }}" class="btn btn-primary">
            <i class="fas fa-chart-bar me-2"></i>Go to Donor Insights
          </a>
        </div>
      </div>
    </div>
  </div>

  {% if projects %}
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for project in projects %}
    <div class="col project-card-wrapper">
      <div class="card h-100 shadow-sm project-card">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0 d-flex justify-content-between align-items-center">
            {{ project.name }}
            <span class="badge project-status-badge
              {% if project.status == 'Ongoing' %}bg-success
              {% elif project.status == 'Planning' %}bg-info
              {% elif project.status == 'Completed' %}bg-secondary
              {% elif project.status == 'On Hold' %}bg-warning
              {% else %}bg-light text-dark
              {% endif %} ms-2"
            >{{ project.status }}</span>
          </h5>
        </div>
        <div class="card-body d-flex flex-column">
          <p class="card-text text-muted small flex-grow-1">{{ project.description | truncate(120) }}</p>

          <div class="goal-section mb-3">
            <strong><i class="fas fa-bullseye me-1"></i>Goal:</strong> 
            <span class="text-muted">{{ project.goal_description | truncate(70) }}</span>
            <div class="progress mt-1" style="height: 10px;">
              {% set progress_percentage = (project.goal_current_value / project.goal_target_value * 100) if project.goal_target_value and project.goal_target_value != 0 else 0 %}
              <div class="progress-bar 
                {% if progress_percentage >= 75 %}bg-success
                {% elif progress_percentage >= 40 %}bg-warning
                {% else %}bg-danger
                {% endif %}" 
                role="progressbar" style="width: {{ progress_percentage }}%;" 
                aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
                {{ "%.0f" | format(progress_percentage) }}%
              </div>
            </div>
          </div>

          <div class="row small text-muted project-meta-info mb-3">
            <div class="col">
              <strong><i class="fas fa-dollar-sign me-1"></i>Budget:</strong> ${{ "{:,.0f}".format(project.budget) if project.budget else 'N/A' }}
            </div>
            <div class="col">
              <strong><i class="fas fa-calendar-alt me-1"></i>Start:</strong> {{ project.start_date.strftime('%Y-%m-%d') if project.start_date else 'N/A' }}
            </div>
          </div>

          <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-primary mt-auto">
            <i class="fas fa-folder-open me-2"></i>View Project Details
          </a>
        </div>
        <div class="card-footer text-muted small">
          Last Updated: {{ project.start_date.strftime('%Y-%m-%d') }}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info" role="alert">
    <i class="fas fa-info-circle me-2"></i>You are not currently managing any projects.
  </div>
  {% endif %}

  <div class="mt-4 text-center">
    <button class="btn btn-success btn-lg disabled" title="Feature coming soon">
      <i class="fas fa-plus-circle me-2"></i>Create New Project
    </button>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
if (typeof Plotly !== 'undefined') {
  const statusLabels = {{ status_labels | tojson }};
  const statusValues = {{ status_values | tojson }};
  if (statusLabels && document.getElementById('projectStatusPieChart')) {
    Plotly.newPlot('projectStatusPieChart', [{
      values: statusValues,
      labels: statusLabels,
      type: 'pie',
      hole: .4,
      textinfo: "label+percent",
      textposition: 'inside',
      marker: { colors: ['#005A9C', '#4CAF50', '#6c757d', '#FFC107', '#D32F2F'] }
    }], {
      height: 350,
      margin: {"t": 30, "b": 30, "l": 30, "r": 30},
      showlegend: true,
      legend: { orientation: "v", x: 1.05, xanchor: "left", y: 0.5, yanchor: "middle" },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      font: { color: 'var(--neutral-text-primary)', family: 'Inter, Segoe UI, system-ui, sans-serif' }
    }, {responsive: true, displaylogo: false});
  }

  const financialLabels = {{ portfolio_financial_labels | tojson }};
  const financialValues = {{ portfolio_financial_values | tojson }};
  if (financialLabels && document.getElementById('portfolioFinancialsBarChart')) {
    Plotly.newPlot('portfolioFinancialsBarChart', [{
      x: financialLabels,
      y: financialValues,
      type: 'bar',
      marker: { color: ['#003D6B', '#005A9C'] },
      width: [0.5, 0.5]
    }], {
      height: 350,
      margin: {"t": 30, "b": 50, "l": 70, "r": 20},
      yaxis: { title: 'Amount ($)', tickprefix: '$' },
      bargap: 0.2,
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      font: { color: 'var(--neutral-text-primary)', family: 'Inter, Segoe UI, system-ui, sans-serif' }
    });
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const filterButtons = document.querySelectorAll('.filter-btn');
  const projectCards = document.querySelectorAll('.project-card-wrapper');

  filterButtons.forEach(button => {
    button.addEventListener('click', function() {
      filterButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');

      const filterStatus = this.getAttribute('data-status');
      projectCards.forEach(card => {
        const badge = card.querySelector('.project-status-badge');
        const status = badge ? badge.textContent.trim() : '';
        card.style.display = (filterStatus === 'all' || status === filterStatus) ? '' : 'none';
      });
    });
  });
});
</script>
{% endblock %}
